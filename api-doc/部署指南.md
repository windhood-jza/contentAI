# 新闻搜索服务部署指南

## 系统要求

### 硬件要求

- **CPU**: 2核心及以上
- **内存**: 最小4GB，推荐8GB
- **磁盘空间**: 最小10GB，视数据量增长调整

### 软件要求

- **操作系统**: Windows Server 2016/2019 或 Linux (CentOS 7+/Ubuntu 18.04+)
- **JDK**: JDK 1.8+
- **数据库**: Oracle 11g/12c
- **Web服务器**: Tomcat 8.5+/9.0+ 或 其他支持Java Web的容器

## 安装步骤

### 1. 准备环境

#### 安装 JDK

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-8-jdk

# CentOS/RHEL
sudo yum install java-1.8.0-openjdk-devel

# 验证安装
java -version
```

#### 安装 Tomcat

```bash
# 下载Tomcat
wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.54/bin/apache-tomcat-9.0.54.tar.gz

# 解压
tar -xvf apache-tomcat-9.0.54.tar.gz
mv apache-tomcat-9.0.54 /opt/tomcat

# 设置权限
chmod +x /opt/tomcat/bin/*.sh
```

### 2. 数据库配置

1. 创建数据库用户和表结构：

```sql
-- 创建用户
CREATE USER newsearch IDENTIFIED BY password;
GRANT CONNECT, RESOURCE TO newsearch;
GRANT CREATE SESSION TO newsearch;
GRANT UNLIMITED TABLESPACE TO newsearch;

-- 连接到用户
CONNECT newsearch/password;

-- 创建表结构（参考数据库模型文档中的表结构）
CREATE TABLE com_basicinfo (
  ID VARCHAR2(32) PRIMARY KEY,
  NAME VARCHAR2(200) NOT NULL,
  CREATED TIMESTAMP NOT NULL,
  LAST_UPDATED TIMESTAMP,
  STATUS NUMBER(1) DEFAULT 1 NOT NULL,
  SORT_NO NUMBER(10)
);

CREATE TABLE cob_program (
  OBJECTID VARCHAR2(32) NOT NULL,
  FIELD1079 CLOB,
  CREATE_TIME TIMESTAMP NOT NULL,
  UPDATE_TIME TIMESTAMP,
  CONSTRAINT FK_PROGRAM_BASICINFO FOREIGN KEY (OBJECTID) REFERENCES com_basicinfo(ID)
);

-- 创建索引
CREATE INDEX IDX_COM_BASICINFO_NAME ON com_basicinfo(NAME);
CREATE INDEX IDX_COM_BASICINFO_CREATED ON com_basicinfo(CREATED);
CREATE INDEX IDX_COB_PROGRAM_OBJECTID ON cob_program(OBJECTID);
```

2. 配置数据库连接（修改 `application.properties` 或 `application.yml`）:

```properties
# 数据库配置
spring.datasource.enabled=true
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver
spring.datasource.url=jdbc:oracle:thin:@[DB_HOST]:1521:[SID]
spring.datasource.username=newsearch
spring.datasource.password=password
```

### 3. 部署应用

#### 方式一：直接部署WAR包

1. 将编译好的WAR包复制到Tomcat的webapps目录:

```bash
cp news.war /opt/tomcat/webapps/
```

2. 启动Tomcat:

```bash
/opt/tomcat/bin/startup.sh
```

#### 方式二：使用Docker部署

1. 创建Dockerfile:

```Dockerfile
FROM tomcat:9-jdk8-openjdk
COPY news.war /usr/local/tomcat/webapps/
EXPOSE 8080
CMD ["catalina.sh", "run"]
```

2. 构建和运行Docker镜像:

```bash
# 构建镜像
docker build -t news-search-service:latest .

# 运行容器
docker run -d -p 8080:8080 --name news-search news-search-service:latest
```

## 配置说明

### 应用配置

应用的主要配置文件位于 `WEB-INF/classes/application.properties`，主要配置项包括：

```properties
# 服务器配置
server.port=8080
server.servlet.context-path=/

# 数据源配置
spring.datasource.enabled=true
spring.datasource.driver-class-name=oracle.jdbc.OracleDriver
spring.datasource.url=jdbc:oracle:thin:@localhost:1521:XE
spring.datasource.username=newsearch
spring.datasource.password=password

# 日志配置
logging.level.root=INFO
logging.level.com.news.service=DEBUG
logging.file.name=/var/log/news-search/application.log
```

### 日志配置

日志配置文件位于 `WEB-INF/classes/logback-spring.xml`，可以根据需要调整日志级别和输出位置。

## 验证部署

### 检查服务状态

访问健康检查接口验证服务是否正常运行：

```
http://[服务器IP]:8080/actuator/health
```

预期返回结果：

```json
{
  "status": "UP",
  "details": {
    "message": "服务运行正常",
    "status": "UP"
  }
}
```

### 验证搜索功能

使用以下命令测试搜索API：

```bash
curl -X POST \
  http://[服务器IP]:8080/api/search \
  -H 'Content-Type: application/json' \
  -d '{
    "keywords": "测试关键词",
    "page": 1,
    "size": 10
  }'
```

## 性能调优

### JVM调优

为Tomcat配置适当的JVM参数：

```bash
# 编辑Tomcat的setenv.sh文件
echo 'JAVA_OPTS="$JAVA_OPTS -Xms1024m -Xmx2048m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m"' > /opt/tomcat/bin/setenv.sh
chmod +x /opt/tomcat/bin/setenv.sh
```

### 连接池配置

在 `application.properties` 中添加连接池配置：

```properties
# HikariCP连接池配置
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.maximum-pool-size=15
spring.datasource.hikari.idle-timeout=30000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.pool-name=NewsSearchHikariCP
```

## 常见问题

### 1. 服务无法启动

**可能原因**：
- JDK版本不匹配
- 数据库连接信息错误
- 端口冲突

**解决方案**：
- 检查JDK版本是否与应用要求匹配
- 验证数据库连接信息是否正确
- 检查端口是否被占用，可以通过 `netstat -an | grep 8080` 查看

### 2. 搜索返回结果为空

**可能原因**：
- 数据库中没有匹配的数据
- 关键词格式不正确

**解决方案**：
- 检查数据库是否包含测试数据
- 尝试使用简单的单个关键词进行测试

### 3. 性能问题

**可能原因**：
- JVM内存不足
- 数据库查询效率低
- 连接池配置不合理

**解决方案**：
- 增加JVM内存配置
- 优化SQL查询，添加合适的索引
- 调整连接池参数，增加最大连接数

## 维护与监控

### 日常维护任务

1. **日志轮转**：配置日志文件的轮转策略，防止单个日志文件过大
2. **数据库备份**：定期进行数据库备份
3. **性能监控**：使用JMX或其他监控工具监控应用性能

### 监控方案

1. **应用监控**：使用Spring Boot Actuator监控应用健康状态
   ```
   http://[服务器IP]:8080/actuator/health
   http://[服务器IP]:8080/actuator/metrics
   ```

2. **资源监控**：使用Prometheus+Grafana等工具监控服务器资源使用情况

3. **告警设置**：配置关键指标的告警阈值，如CPU使用率>80%、内存使用率>85%等 